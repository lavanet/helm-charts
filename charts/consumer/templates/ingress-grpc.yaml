{{- if .Values.ingressGrpc.enabled }}
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: {{ include "consumer.fullname" . }}-grpc
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "consumer.labels" . | nindent 4 }}
    {{- with .Values.ingressGrpc.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with .Values.ingressGrpc.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  {{- with .Values.ingressGrpc.className }}
  ingressClassName: {{ . }}
  {{- end }}
  {{- if .Values.ingressGrpc.tls }}
  tls:
    - hosts:
      {{- range $itemKey, $itemValue := $.Values.chains }}
      {{- $interfaces := dict }}
      {{- range $interfaceDetails := $itemValue.interfaces }}
      {{- $_ := set $interfaces $interfaceDetails.interface . }}
      {{- end }}
      {{- range $interfaceEntry := $interfaces }}
      {{- if (eq ($interfaceEntry.interface | lower) "grpc") }}
        {{- if eq $.Values.ingressGrpc.hostStructure "chain-interface" }}
        - "{{ $itemKey | lower }}-{{ $interfaceEntry.interface | lower }}.{{ include "consumer.domain" $ }}"
        {{- else }}
        - "{{ $itemKey | lower }}.{{ $interfaceEntry.interface | lower }}.{{ include "consumer.domain" $ }}"
        {{- end }}
        ## If the interface is the default interface don't add the interface name
        {{- if (eq $interfaceEntry.default true) }}
        - "{{ $itemKey | lower }}.{{ include "consumer.domain" $ }}"
        {{- end }}
      {{- end }}
      {{- end }}
      {{- end }}
      {{- with .Values.ingressGrpc.tlsSecretName }}
      secretName: {{ . }}
      {{- else }}
      secretName: consumer-grpc-tls
      {{- end }}
  {{- end }}
  rules:
    {{- range $itemKey, $itemValue := $.Values.chains }}
    {{- $interfaces := dict }}
    {{- range $interfaceDetails := $itemValue.interfaces }}
    {{- $_ := set $interfaces $interfaceDetails.interface . }}
    {{- end }}
    {{- range $interfaceEntry := $interfaces }}
    {{- if (eq ($interfaceEntry.interface | lower) "grpc") }}
      {{- if eq $.Values.ingressGrpc.hostStructure "chain-interface" }}
    - host: "{{ $itemKey | lower }}-{{ $interfaceEntry.interface | lower }}.{{ include "consumer.domain" $ }}"
      {{- else }}
    - host: "{{ $itemKey | lower }}.{{ $interfaceEntry.interface | lower }}.{{ include "consumer.domain" $ }}"
      {{- end }}
      http:
        paths:
          - path: {{ $.Values.ingressGrpc.path }}
            pathType: {{ $.Values.ingressGrpc.pathType }}
            backend:
              service:
                name: {{ $itemKey | lower }}-{{ include "consumer.fullname" $ }}
                port:
                  name: {{ $interfaceEntry.interface | lower }}
      ## If the interface is the default interface don't add the interface name
      {{- if (eq $interfaceEntry.default true) }}
    - host: "{{ $itemKey | lower }}.{{ include "consumer.domain" $ }}"
      http:
        paths:
          - path: {{ $.Values.ingressGrpc.path }}
            pathType: {{ $.Values.ingressGrpc.pathType }}
            backend:
              service:
                name: {{ $itemKey | lower }}-{{ include "consumer.fullname" $ }}
                port:
                  name: {{ $interfaceEntry.interface | lower }}
      {{- end }}
    {{- end }}
    {{- end }}
    {{- end }}
{{- end }}
